var __defProp=Object.defineProperty,__typeError=i=>{throw TypeError(i)},__defNormalProp=(i,a,s)=>a in i?__defProp(i,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[a]=s,__publicField=(i,a,s)=>__defNormalProp(i,"symbol"!=typeof a?a+"":a,s),__accessCheck=(i,a,s)=>a.has(i)||__typeError("Cannot "+s),__privateGet=(i,a,s)=>(__accessCheck(i,a,"read from private field"),s?s.call(i):a.get(i)),__privateAdd=(i,a,s)=>a.has(i)?__typeError("Cannot add the same private member more than once"):a instanceof WeakSet?a.add(i):a.set(i,s),__privateSet=(i,a,s,r)=>(__accessCheck(i,a,"write to private field"),r?r.call(i,s):a.set(i,s),s),__privateMethod=(i,a,s)=>(__accessCheck(i,a,"access private method"),s);!function(){"use strict";var i,a,s,r,u,d,c,l;const h=class _DgObservable{constructor(d,c){__privateAdd(this,u),__privateAdd(this,i),__privateAdd(this,a,new Set),__privateAdd(this,s,!1),__privateAdd(this,r),__privateSet(this,i,d),__privateSet(this,r,c)}getValue(){return __privateMethod(this,u,d).call(this),__privateGet(this,i)}setValue(s){__privateGet(this,i)!==s&&(__privateSet(this,i,s),__privateGet(this,a).forEach((i=>__privateMethod(this,u,c).call(this,i))))}subscribe(i,{immediate:s}={}){return __privateMethod(this,u,d).call(this),__privateGet(this,a).add(i),s&&__privateMethod(this,u,c).call(this,i),()=>__privateMethod(this,u,l).call(this,i)}};i=new WeakMap,a=new WeakMap,s=new WeakMap,r=new WeakMap,u=new WeakSet,d=function(){var i;__privateGet(this,s)||(__privateSet(this,s,!0),null==(i=__privateGet(this,r))||i.call(this))},c=async function(a){await Promise.resolve(a(__privateGet(this,i)))===h.unsubscribeToken&&__privateMethod(this,u,l).call(this,a)},l=function(i){__privateGet(this,a).delete(i)},__publicField(h,"unsubscribeToken",Symbol("unsubscribe"));let g=h;var v=(i=>(i.local="local",i.dev="dev",i.test="test",i.stage="stage",i.demo="demo",i.prod="prod",i))(v||{});class BaseLogger{constructor(i,a,s,r){__publicField(this,"moduleName"),__publicField(this,"minLogLevel",0),__publicField(this,"context");const u=s?`::${s}`:"";this.moduleName=`${i}${u}`,this.context=r,a&&this.setEnv(a)}setEnv(i){this.minLogLevel="prod"===i?2:"demo"===i?1:0}debug(...i){this.minLogLevel<=0&&console.debug(`${this.moduleName}: `,...i,this.context)}info(...i){this.minLogLevel<=1&&console.info(`${this.moduleName}: `,...i,this.context)}log(...i){this.minLogLevel<=1&&console.log(`${this.moduleName}: `,...i,this.context)}warn(...i){this.minLogLevel<=2&&console.warn(`${this.moduleName}: `,...i,this.context)}error(...i){this.minLogLevel<=3&&console.error(`${this.moduleName}: `,...i,this.context)}}var p=(i=>(i.toyota="toyota",i.lexus="lexus",i))(p||{}),w=(i=>(i.topNavSaveHeart="dg-save-heart",i.inlineSaveHeart="dg-inline-saves",i.shoppingCart="dg-shopping-cart",i.navMenu="dg-nav-menu",i.progressTracker="dg-progress-tracker",i.toastNotification="dg-toast-notification",i))(w||{}),_=(i=>(i.owners="/owners",i.dashboard="/owners/dashboard",i.profile="/profile",i.saves="/saves",i.tradeIns="/trade",i.deals="/my-deals",i))(_||{});var m,f,b,y;(f=m||(m={})).local="local",f.dev="dev",f.test="test",f.stage="stage",f.demo="demo",f.prod="prod",(y=b||(b={})).toyota="toyota",y.lexus="lexus";b.toyota,b.lexus,m.local,m.dev,m.test,m.stage,m.demo,m.prod;const E={MstcSubdomain:{[p.toyota]:"smartpath",[p.lexus]:"monogram"},defaultBuildsRoute:{[p.toyota]:"/configurator",[p.lexus]:"/build-your-lexus/#!/series"},tierPatterns:{t1ToyotaPattern:".toyota.com",t2ToyotaPattern:".buyatoyota.com",t2ToyotaSubprodPattern:".nonprod.jsds.tms.aws.toyota.com",t1LexusPattern:".lexus.com"}};class ReadonlyDGDataHub{static get _windowDataHub(){return window.DGDataHub}static validatePageDataHub(){if(!this._windowDataHub||"object"!=typeof this._windowDataHub)throw new Error("window.DGDataHub must be defined as an object");if("string"!=typeof this._windowDataHub.DEPLOY_ENV)throw new Error("DGDataHub.DEPLOY_ENV must be defined as a string");const i=p.toyota;ReadonlyDGDataHub.brand!==i&&console.warn("DGDataHub.BRAND does not match dg-ui script version",{scriptBrand:i,DGDataHubBrand:ReadonlyDGDataHub.brand})}static isComponentIncludedOnPage(i){var a;return i===w.inlineSaveHeart||!!(null==(a=this._windowDataHub.components)?void 0:a[i])}static get brand(){return function asBrand(i){switch(null==i?void 0:i.toLowerCase()){case"toyota":return p.toyota;case"lexus":return p.lexus;default:return}}(this._windowDataHub.BRAND)||p.toyota}static get environment(){var i;const a=null==(i=this._windowDataHub)?void 0:i.DEPLOY_ENV.toLowerCase();return window.location.toString().includes(E.tierPatterns.t2ToyotaSubprodPattern)?window.location.toString().includes("stg")?v.demo:v.stage:a||v.local}static get isMstc(){return!!this._windowDataHub.isMSTC}static get dealerCd(){return this._windowDataHub.dealerCd}static get zipCode(){return this._windowDataHub.zipCode}static get showContinuePurchaseText(){return this._windowDataHub.showContinuePurchaseText??!0}static get buildsRoute(){var i;return(null==(i=this._windowDataHub.pageRoutes)?void 0:i.buildRoute)||null}static get savesRoute(){var i;return(null==(i=this._windowDataHub.pageRoutes)?void 0:i.savesRoute)||_.saves}static get dealsRoute(){var i;return(null==(i=this._windowDataHub.pageRoutes)?void 0:i.dealsRoute)||_.deals}static get profileRoute(){return _.profile}static get dealerAgnosticFeatureConfig(){var i;return null==(i=this._windowDataHub.features)?void 0:i.dealerAgnostic}static get invertNavMenuIcons(){return!!this._windowDataHub.invertNavMenuIcons}static get isInIFrame(){return!!this._windowDataHub.iFrame}}const k=new class Logger extends BaseLogger{constructor(i,a="dg-ui"){super(a,ReadonlyDGDataHub.environment,i,void 0)}}("script","dg-auth");class AuthState{constructor(){__publicField(this,"isAuthInProgressObservable"),this.isAuthInProgressObservable=new g(!1),AuthState.setObservableOnDataHub(this.isAuthInProgressObservable)}static setObservableOnDataHub(i){const a=window.DGDataHub;a?(a.__internal__??(a.__internal__={}),a.__internal__.isAuthInProgress=i):setTimeout((()=>AuthState.setObservableOnDataHub(i)),50)}set isAuthInProgress(i){k.debug("Setting isAuthInProgress",i),this.isAuthInProgressObservable.setValue(i)}get isAuthInProgress(){return this.isAuthInProgressObservable.getValue()}}
/*! js-cookie v3.0.5 | MIT */function assign(i){for(var a=1;a<arguments.length;a++){var s=arguments[a];for(var r in s)i[r]=s[r]}return i}var A=function init(i,a){function set(s,r,u){if("undefined"!=typeof document){"number"==typeof(u=assign({},a,u)).expires&&(u.expires=new Date(Date.now()+864e5*u.expires)),u.expires&&(u.expires=u.expires.toUTCString()),s=encodeURIComponent(s).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var d="";for(var c in u)u[c]&&(d+="; "+c,!0!==u[c]&&(d+="="+u[c].split(";")[0]));return document.cookie=s+"="+i.write(r,s)+d}}return Object.create({set:set,get:function get(a){if("undefined"!=typeof document&&(!arguments.length||a)){for(var s=document.cookie?document.cookie.split("; "):[],r={},u=0;u<s.length;u++){var d=s[u].split("="),c=d.slice(1).join("=");try{var l=decodeURIComponent(d[0]);if(r[l]=i.read(c,l),a===l)break}catch(h){}}return a?r[a]:r}},remove:function(i,a){set(i,"",assign({},a,{expires:-1}))},withAttributes:function(i){return init(this.converter,assign({},this.attributes,i))},withConverter:function(i){return init(assign({},this.converter,i),this.attributes)}},{attributes:{value:Object.freeze(a)},converter:{value:Object.freeze(i)}})}({read:function(i){return'"'===i[0]&&(i=i.slice(1,-1)),i.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(i){return encodeURIComponent(i).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"});function getBaseDomain(i){const a=i.hostname.split(".");return a.length>2?`.${a[a.length-2]}.${a[a.length-1]}`:i.hostname}class BooleanCookie{constructor(i){__publicField(this,"name"),this.name=i}get(){return"true"===function getCookie(i){return A.get(i)}(this.name)}set(i){i?function setCookie(i,a){A.set(i,a,getCookieOptions())}(this.name,`${i}`):function removeCookie(i){A.remove(i,getCookieOptions())}(this.name)}}function getCookieOptions(){return{domain:function getPageOrigin(i=(i=>null==(i=null==window?void 0:window.location)?void 0:i.href)()){try{const a=new URL(i).hostname.split(".");return a.length>1?a.slice(a.length-2).join("."):a[0]?a[0]:__IS_LEXUS__?"lexus.com":"tldealersystems.com"}catch{return null}}()||void 0}}const D=new BooleanCookie("dg_was_auto_logged"),S=new BooleanCookie("dg_show_auto_logged_out_notification");class PersistedArray{constructor(i,a,s){__publicField(this,"key"),__publicField(this,"isEqual"),__publicField(this,"sizeLimit"),this.key=i,this.isEqual=s,this.sizeLimit=a}addItem(i){const a=this.items;return a.some((a=>this.isSameItem(a,i)))?(k.debug("Skipping add because it is already in the list",i),!1):(this.items=[...a,i],!0)}get items(){try{const i=A.get(this.key),a=i?JSON.parse(i):[];return Array.isArray(a)?a:[]}catch{return[]}}set items(i){const a=i.slice(-this.sizeLimit),s=JSON.stringify(a);A.withConverter({write:i=>i.toString()}).set(this.key,s,{domain:getBaseDomain(window.location)})}removeItem(i){this.items=this.items.filter((a=>!this.isSameItem(a,i)))}isSameItem(i,a){return"function"==typeof this.isEqual?this.isEqual(i,a):i===a}}var C=(i=>(i.tokenRequested="TOKEN_REQUESTED",i.tokenCreated="TOKEN_CREATED",i.tokenDeleted="TOKEN_DELETED",i))(C||{});function makeAuthEvent(i){!function validateRawAuthEvent(i){if(!i||"object"!=typeof i)throw new RawAuthEventValidateError("Must be a truthy object",i);const a=Object.keys(i||{});if(1!==a.length)throw new RawAuthEventValidateError("Must have only one key",i);const s=a[0];if(!function isValidRawAuthKey(i){return Object.values(C).includes(i)}(s))throw new RawAuthEventValidateError(`Key must be an event type, not '${s}'`,i);const r=i[s];if(!(null==r?void 0:r.env))throw new RawAuthEventValidateError("Data must contain an 'env' property",i);if(!(null==r?void 0:r.requestId))throw new RawAuthEventValidateError("Data must contain a 'requestId' property",i);return!0}(i);const a=Object.keys(i)[0];return{type:a,data:i[a]}}function isSameAuthEvent(i,a){return i.type===a.type&&!!i.data.requestId&&i.data.requestId===a.data.requestId&&i.data.env===a.data.env}class RawAuthEventValidateError extends Error{constructor(i,a){super(`Invalid RawAuthEvent: ${i}`),__publicField(this,"event"),this.event=a}}const H={1:{[v.local]:"https://api-t1.stage.dg.toyota.com",[v.dev]:"https://api-t1.dev.dg.toyota.com",[v.test]:"https://api-t1.test.dg.toyota.com",[v.stage]:"https://api-t1.stage.dg.toyota.com",[v.demo]:"https://api-t1.demo.dg.toyota.com",[v.prod]:"https://api-t1.dg.toyota.com"},2:{[v.local]:"https://api-t1.stage.dg.toyota.com",[v.dev]:"https://api-t1.dev.dg.toyota.com",[v.test]:"https://api-t1.test.dg.toyota.com",[v.stage]:"https://api-t1.stage.dg.toyota.com",[v.demo]:"https://api-t1.demo.dg.toyota.com",[v.prod]:"https://api-t1.dg.toyota.com"},3:{[v.local]:"https://api.stage.dg.toyota.com",[v.dev]:"https://api.dev.dg.toyota.com",[v.test]:"https://api.test.dg.toyota.com",[v.stage]:"https://api.stage.dg.toyota.com",[v.demo]:"https://api.demo.dg.toyota.com",[v.prod]:"https://api.dg.toyota.com"}};function e(i){this.message=i}e.prototype=new Error,e.prototype.name="InvalidCharacterError";var I="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(i){var a=String(i).replace(/=+$/,"");if(a.length%4==1)throw new e("'atob' failed: The string to be decoded is not correctly encoded.");for(var s,r,u=0,d=0,c="";r=a.charAt(d++);~r&&(s=u%4?64*s+r:r,u++%4)?c+=String.fromCharCode(255&s>>(-2*u&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return c};function n(i){this.message=i}function o(i,a){if("string"!=typeof i)throw new n("Invalid token specified");var s=!0===(a=a||{}).header?0:1;try{return JSON.parse(function t(i){var a=i.replace(/-/g,"+").replace(/_/g,"/");switch(a.length%4){case 0:break;case 2:a+="==";break;case 3:a+="=";break;default:throw"Illegal base64url string!"}try{return decodeURIComponent(I(a).replace(/(.)/g,(function(i,a){var s=a.charCodeAt(0).toString(16).toUpperCase();return s.length<2&&(s="0"+s),"%"+s})))}catch(s){return I(a)}}(i.split(".")[s]))}catch(r){throw new n("Invalid token specified: "+r.message)}}n.prototype=new Error,n.prototype.name="InvalidTokenError";const P=new BaseLogger("getIdToken");function checkIdTokenCookie(i){const a=A.get(i);if("string"==typeof a){if(function isJWT(i){if(!i)return!1;try{return Object.keys(o(i)).length>0}catch{return P.debug("Invalid JWT provided"),!1}}(a))return{isValidJWT:!0,jwt:a};if("true"===a.toLowerCase())return{pkceSaysTheyAreLoggedIn:!0}}return{}}function wait(i){return new Promise((a=>setTimeout(a,i)))}const T={delayMs:100,timeoutMs:1e3,suppressErrors:!1};function retryUntilTruthyOrTimeout(i,a){const s={...T,...a};return function cancelAfter(i,a){const s={isCanceled:!1},r=setTimeout((()=>s.isCanceled=!0),i);return a(s).finally((()=>clearTimeout(r)))}(s.timeoutMs,(async a=>{for(;!a.isCanceled;){try{const a=i();if(a)return a}catch(r){if(!s.suppressErrors)throw r}await wait(s.delayMs)}return i()}))}const L={};async function getDgApi(i){const a=L[i];if(a)return a;const s=async function _getDgApi(i){return new DgApi(i)}(i);return L[i]=s,s}class DgApi{constructor(i){__publicField(this,"env"),this.env=i}handleLogin(){const i=`${this.getBaseUrl()}/garage/v2/auth/events/login`,a=this.buildBody();return a.dgid?a.id_token?postJson(i,a):(k.info("No id_token, skipping login event POST"),null):(k.info("No dgid, skipping login event POST"),null)}handleLogout(){const i=`${this.getBaseUrl()}/garage/v2/auth/events/logout`,a=this.buildBody();return a.dgid?postJson(i,a):(k.info("No dgid, skipping logout event POST"),null)}getBaseUrl(){const i=H[function getTier(){const i=window.location.hostname;return i.includes(E.tierPatterns.t2ToyotaPattern)||i.includes(E.tierPatterns.t2ToyotaSubprodPattern)?2:i.includes(E.tierPatterns.t1ToyotaPattern)||i.includes(E.tierPatterns.t1LexusPattern)&&!i.includes(E.MstcSubdomain.lexus)?1:3}()][this.env];if(!i)throw new Error(`No dgApi url found for env: '${this.env}'`);return i}buildBody(){const i=this.getDgid(),{value:a,reason:s}=this.getIdToken();return{dgid:i,id_token:a,meta:{reason:s,source:window.location.href??"unknown"}}}getDgid(){const i=function getDgidCookieName(i){return`dgid_${i}`}(this.env);return A.get(i)}getIdToken(){const i="prod"===this.env?"id_token":"id_token_tmnab2cqa";return this.getIdTokenValueWithReason(i)}getIdTokenValueWithReason(i){const a=checkIdTokenCookie(i);if(a.isValidJWT)return{value:a.jwt,reason:"valid_jwt"};if(a.pkceSaysTheyAreLoggedIn){k.debug("Getting id_token information from local storage");const a=localStorage.getItem(i);return a?{value:a,reason:"pkce_use_local_token"}:{value:null,reason:"pkce_no_local_token"}}return{value:null,reason:"catch_all_invalid_token"}}}async function postJson(i,a){var s;return await retryUntilTruthyOrTimeout((()=>window.AwsWafIntegration),{delayMs:100,timeoutMs:5e3})?fetch(i,{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json","X-Aws-Waf-Token":await(null==(s=window.AwsWafIntegration)?void 0:s.getToken())??"No Challenge Loaded"}}):(k.warn("Challenge script not loaded. Skipping event",a),null)}class EventHandler{constructor(i){__publicField(this,"authState"),__publicField(this,"inProgressEvents"),__publicField(this,"finishedEvents"),this.authState=i,this.inProgressEvents=new PersistedArray("dg-auth-events-in-progress",5,isSameAuthEvent),this.finishedEvents=new PersistedArray("dg-auth-events-finished",5,isSameAuthEvent)}async finishPendingEvents(){const i=this.inProgressEvents.items;if(i.length>0){k.debug("Finishing pending events",i);for(const a of i)await this.handleEvent(a)}}queueEvents(i){if(i.length>0){k.debug("Queueing events",i);for(const a of i)this.setEventHandlingState("started",a)}}async handleEvent(i){if(this.eventHasAlreadyBeenHandled(i))return k.debug("Skipping event, because it was already handled",i),void this.setEventHandlingState("finished",i);k.info("Handling event",i),this.setEventHandlingState("started",i);try{await this._handleEvent(i),k.debug("Successfully handled event",i)}catch(a){k.error("Error handling event",i,a)}finally{this.setEventHandlingState("finished",i)}}_setAutoLogoutEventCookies(){D.set(!0),S.set(!0)}_removeAutoLogoutEventCookies(){D.set(!1),S.set(!1)}async _handleEvent(i){var a,s;let r=null==(s=null==(a=window.DGDataHub)?void 0:a.DEPLOY_ENV)?void 0:s.toLowerCase();if(!r){const i="__dg_override_env__",a=window.localStorage.getItem(i)||window.sessionStorage.getItem(i);r=null==a?void 0:a.toLowerCase()}const u=r||i.data.env;switch(k.setEnv(u),i.type){case C.tokenRequested:this.authState.isAuthInProgress=!0;break;case C.tokenCreated:await this.processAuth((()=>async function handleLogin(i){return(await getDgApi(i)).handleLogin()}(u))),this._removeAutoLogoutEventCookies();break;case C.tokenDeleted:await this.processAuth((()=>async function handleLogout(i){return(await getDgApi(i)).handleLogout()}(u))),"SESSION_TIMEOUT"===i.data.logout_reason&&this._setAutoLogoutEventCookies();break;default:k.warn(`Invalid event type: ${i.type}`)}}async processAuth(i){this.authState.isAuthInProgress=!0;try{await i()}finally{this.authState.isAuthInProgress=!1}}eventHasAlreadyBeenHandled(i){return this.finishedEvents.items.some((a=>isSameAuthEvent(a,i)))}setEventHandlingState(i,a){"started"===i?this.inProgressEvents.addItem(a):"finished"===i&&(this.inProgressEvents.removeItem(a),this.finishedEvents.addItem(a))}}async function waitForWindowEventHub(){return function validateWindowEventHub(i){if(!i)throw new Error("Event Hub was not truthy");if(!Array.isArray(i.events))throw new Error("Event Hub did not have 'events' property that is an array");return i}(await retryUntilTruthyOrTimeout(getWindowEventHub,{delayMs:50,timeoutMs:1e4}))}function getWindowEventHub(){var i;return null==(i=window.pkce)?void 0:i.eventHistory}class EventHub{constructor(i){__publicField(this,"windowEventHub"),this.windowEventHub=i}getEvents(){const i=this.windowEventHub.events;if(!Array.isArray(i))throw new Error("Event history must be an array");return i.map((i=>makeAuthEvent(i))).reduce(((i,a)=>{const s=a.type===C.tokenRequested||a.type===C.tokenDeleted?[]:i;return s.push(a),s}),[])}}!async function main(){try{const i=new AuthState,a=await async function getEventHub(){try{return await async function createEventHub(){const i=await waitForWindowEventHub();return new EventHub(i)}()}catch(i){return k.warn("Unable to create Event Hub",i),null}}();if(!a)return;k.debug("Handling events"),await async function handleEvents(i,a){const s=new EventHandler(a);window.addEventListener("beforeunload",(()=>{const a=i.getEvents();k.debug("Queueing events",JSON.stringify(a)),s.queueEvents(a)})),await s.finishPendingEvents();const r=i.getEvents();for(const u of r)await s.handleEvent(u)}(a,i),k.debug("Finished handling events")}catch(i){k.error(i)}}()}();
//# sourceMappingURL=dg-auth.min.js.map
